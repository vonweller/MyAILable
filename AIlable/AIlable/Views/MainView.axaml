<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:AIlable.ViewModels"
             xmlns:controls="clr-namespace:AIlable.Controls"
             xmlns:models="clr-namespace:AIlable.Models"
             xmlns:views="clr-namespace:AIlable.Views"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
             x:Class="AIlable.Views.MainView"
             x:DataType="vm:MainViewModel"
             Focusable="True"
             Background="{DynamicResource AppBackgroundBrush}">

  <UserControl.KeyBindings>
    <KeyBinding Gesture="Ctrl+F" Command="{Binding FitToWindowCommand}" />
    <KeyBinding Gesture="Ctrl+R" Command="{Binding ResetViewCommand}" />
    <KeyBinding Gesture="Ctrl+T" Command="{Binding ToggleThemeCommand}" />
    <KeyBinding Gesture="Ctrl+S" Command="{Binding SaveProjectCommand}" />
    <KeyBinding Gesture="Ctrl+Shift+S" Command="{Binding SaveProjectAsCommand}" />
  </UserControl.KeyBindings>

  <Design.DataContext>
    <vm:MainViewModel />
  </Design.DataContext>

  <UserControl.Styles>
    <!-- å·¥å…·æŒ‰é’®æ ·å¼ -->
    <Style Selector="Button.tool-button">
      <Setter Property="Background" Value="#3498DB" />
      <Setter Property="Foreground" Value="White" />
      <Setter Property="BorderBrush" Value="Transparent" />
      <Setter Property="BorderThickness" Value="0" />
      <Setter Property="Padding" Value="16,10" />
      <Setter Property="Margin" Value="6" />
      <Setter Property="CornerRadius" Value="8" />
      <Setter Property="FontWeight" Value="Medium" />
      <Setter Property="FontSize" Value="12" />
    </Style>

    <Style Selector="Button.tool-button:pointerover">
      <Setter Property="Background" Value="#2980B9" />
    </Style>

    <Style Selector="Button.tool-button:pressed">
      <Setter Property="Background" Value="#1F618D" />
    </Style>

    <!-- é€‰ä¸­çš„å·¥å…·æŒ‰é’®æ ·å¼ -->
    <Style Selector="Button.tool-button.selected">
      <Setter Property="Background" Value="#27AE60" />
    </Style>

    <Style Selector="Button.tool-button.selected:pointerover">
      <Setter Property="Background" Value="#229954" />
    </Style>

    <!-- æ ‡ç­¾æŒ‰é’®æ ·å¼ -->
    <Style Selector="Button.label-button">
      <Setter Property="Background" Value="#E74C3C" />
      <Setter Property="Foreground" Value="White" />
      <Setter Property="BorderBrush" Value="Transparent" />
      <Setter Property="BorderThickness" Value="0" />
      <Setter Property="Padding" Value="12,8" />
      <Setter Property="Margin" Value="4" />
      <Setter Property="CornerRadius" Value="6" />
      <Setter Property="FontWeight" Value="Medium" />
      <Setter Property="FontSize" Value="11" />
    </Style>

    <Style Selector="Button.label-button:pointerover">
      <Setter Property="Background" Value="#C0392B" />
    </Style>
  </UserControl.Styles>

  <DockPanel>
    <!-- Menu Bar -->
    <Menu DockPanel.Dock="Top" Background="{DynamicResource AppBackgroundBrush}" Foreground="{DynamicResource PrimaryTextBrush}" Padding="8,6"
          BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1">
      <MenuItem Header="æ–‡ä»¶">
        <MenuItem Header="æ–°å»ºé¡¹ç›®" Command="{Binding CreateNewProjectCommand}" />
        <MenuItem Header="æ‰“å¼€é¡¹ç›®..." Command="{Binding OpenProjectCommand}" />
        <Separator />
        <MenuItem Header="ä¿å­˜é¡¹ç›®" Command="{Binding SaveProjectCommand}" InputGesture="Ctrl+S" />
        <MenuItem Header="å¦å­˜ä¸º..." Command="{Binding SaveProjectAsCommand}" InputGesture="Ctrl+Shift+S" />
        <Separator />
        <MenuItem Header="æ·»åŠ å›¾åƒ..." Command="{Binding AddImagesCommand}" />
        <MenuItem Header="æ‰“å¼€å›¾åƒ..." Command="{Binding LoadImageCommand}" />
        <Separator />
        <MenuItem Header="é€€å‡º" />
      </MenuItem>
      <MenuItem Header="è§†å›¾">
        <MenuItem Header="é€‚åº”çª—å£" Command="{Binding FitToWindowCommand}" InputGesture="Ctrl+F" />
        <MenuItem Header="é‡ç½®è§†å›¾" Command="{Binding ResetViewCommand}" InputGesture="Ctrl+R" />
        <Separator />
        <MenuItem Header="åˆ‡æ¢ä¸»é¢˜" Command="{Binding ToggleThemeCommand}" InputGesture="Ctrl+T" />
      </MenuItem>
      <MenuItem Header="å¯¼å‡º">
        <MenuItem Header="å¯¼å‡ºæ•°æ®é›†..." Command="{Binding ExportProjectCommand}" />
      </MenuItem>
      <MenuItem Header="AIChat" Command="{Binding OpenAIChatCommand}" />
      <MenuItem Header="å¸®åŠ©">
        <MenuItem Header="å…³äºŽ" />
      </MenuItem>
    </Menu>

    <!-- Status Bar -->
    <Border DockPanel.Dock="Bottom"
            Background="{DynamicResource PanelBackgroundBrush}"
            BorderBrush="{DynamicResource BorderBrush}"
            BorderThickness="0,1,0,0"
            Padding="12,8">
      <Grid>
        <TextBlock Text="{Binding StatusText}"
                   VerticalAlignment="Center"
                   Foreground="{DynamicResource PrimaryTextBrush}"
                   FontWeight="Medium"
                   FontSize="13" />
        <StackPanel Orientation="Horizontal"
                   Spacing="20"
                   HorizontalAlignment="Right"
                   VerticalAlignment="Center">
          <Border Background="#E8F5E8"
                  CornerRadius="12"
                  Padding="8,4"
                  IsVisible="{Binding HasImage}">
            <TextBlock Text="{Binding CurrentImage.Width, StringFormat='å®½åº¦: {0}'}"
                       Foreground="#27AE60"
                       FontSize="11"
                       FontWeight="Medium" />
          </Border>
          <Border Background="#E8F5E8"
                  CornerRadius="12"
                  Padding="8,4"
                  IsVisible="{Binding HasImage}">
            <TextBlock Text="{Binding CurrentImage.Height, StringFormat='é«˜åº¦: {0}'}"
                       Foreground="#27AE60"
                       FontSize="11"
                       FontWeight="Medium" />
          </Border>
          <Border Background="#E3F2FD"
                  CornerRadius="12"
                  Padding="8,4"
                  IsVisible="{Binding HasImage}">
            <TextBlock Text="{Binding Annotations.Count, StringFormat='æ ‡æ³¨: {0}'}"
                       Foreground="#2196F3"
                       FontSize="11"
                       FontWeight="Medium" />
          </Border>
          <TextBlock Text="å¿«æ·é”®: W/S-åˆ‡æ¢å›¾åƒ A/D-åˆ‡æ¢æ ‡ç­¾ Ctrl+S-ä¿å­˜"
                     FontSize="10"
                     Foreground="#7F8C8D"
                     IsVisible="{Binding HasProject}" />
        </StackPanel>
      </Grid>
    </Border>

    <!-- Main Content Area -->
    <Grid>
      <!-- æ ‡æ³¨è§†å›¾ -->
      <Grid IsVisible="{Binding !IsAIChatViewActive}">
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="200" MinWidth="150" />
          <ColumnDefinition Width="5" />
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="5" />
          <ColumnDefinition Width="280" MinWidth="250" MaxWidth="350" />
        </Grid.ColumnDefinitions>

        <!-- Left Panel - Project Explorer -->
        <Border Grid.Column="0" Background="{DynamicResource PanelBackgroundBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,0,1,0"
                IsVisible="{Binding HasProject}">
          <DockPanel Margin="16">
            <TextBlock DockPanel.Dock="Top" Text="é¡¹ç›®æµè§ˆå™¨"
                       FontWeight="SemiBold"
                       FontSize="16"
                       Foreground="#2C3E50"
                       Margin="0,0,0,16" />
            
            <ScrollViewer>
              <StackPanel>
                <Border Background="#F8F9FA"
                        BorderBrush="#E1E8ED"
                        BorderThickness="1"
                        CornerRadius="8"
                        Padding="16"
                        Margin="0,0,0,16">
                  <StackPanel>
                    <TextBlock Text="å½“å‰é¡¹ç›®"
                               FontWeight="SemiBold"
                               FontSize="13"
                               Foreground="#2C3E50"
                               Margin="0,0,0,8" />
                    <TextBlock Text="{Binding CurrentProject.Name}"
                               IsVisible="{Binding HasProject}"
                               FontSize="12"
                               Foreground="#34495E" />
                    <TextBlock Text="æ— é¡¹ç›®"
                               IsVisible="{Binding !HasProject}"
                               FontSize="12"
                               Foreground="#95A5A6" />
                  </StackPanel>
                </Border>

                <TextBlock Text="å›¾åƒåˆ—è¡¨"
                           FontWeight="SemiBold"
                           FontSize="13"
                           Foreground="#2C3E50"
                           Margin="0,0,0,8" />
                <ListBox ItemsSource="{Binding CurrentProject.Images}"
                         SelectedIndex="{Binding CurrentImageIndex}"
                         SelectedItem="{Binding CurrentImage}"
                         IsVisible="{Binding HasProject}"
                         MinHeight="200"
                         Name="ImageListBox"
                         Background="{DynamicResource CardBackgroundBrush}"
                         BorderBrush="{DynamicResource BorderBrush}"
                         BorderThickness="1"
                         CornerRadius="6"
                         Padding="8">
                  <ListBox.ItemTemplate>
                    <DataTemplate>
                      <Border Background="Transparent"
                              Padding="10,8"
                              Margin="0,2"
                              CornerRadius="4">
                        <StackPanel Orientation="Vertical">
                          <TextBlock Text="{Binding FileName}"
                                     FontWeight="Medium"
                                     FontSize="12"
                                     Foreground="#24292F" />
                          <TextBlock Text="{Binding Annotations.Count, StringFormat='æ ‡æ³¨: {0}'}"
                                     FontSize="10"
                                     Foreground="#656D76"
                                     Margin="0,2,0,0" />
                        </StackPanel>
                      </Border>
                    </DataTemplate>
                  </ListBox.ItemTemplate>
                  <ListBox.Styles>
                    <Style Selector="ListBoxItem:selected /template/ ContentPresenter">
                      <Setter Property="Background" Value="#E7F3FF" />
                    </Style>
                    <Style Selector="ListBoxItem:selected Border">
                      <Setter Property="Background" Value="#E7F3FF" />
                    </Style>
                    <Style Selector="ListBoxItem:pointerover Border">
                      <Setter Property="Background" Value="#F6F8FA" />
                    </Style>
                  </ListBox.Styles>
                </ListBox>
              </StackPanel>
            </ScrollViewer>
          </DockPanel>
        </Border>

        <GridSplitter Grid.Column="1" Width="5" IsVisible="{Binding HasProject}" />

        <!-- Center Panel - Image Canvas -->
        <Border Grid.Column="2" Background="{DynamicResource SystemControlBackgroundAltHighBrush}">
          <Grid>
            <!-- Image Canvas -->
            <controls:ImageCanvas Name="ImageCanvas"
                                 Image="{Binding CurrentImageBitmap}"
                                 Annotations="{Binding Annotations}"
                                 SelectedAnnotation="{Binding SelectedAnnotation}"
                                 IsVisible="{Binding HasImage}" />

            <!-- Placeholder when no project -->
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center"
                       IsVisible="{Binding !HasProject}">
              <Border Background="{DynamicResource CardBackgroundBrush}"
                      BorderBrush="{DynamicResource BorderBrush}"
                      BorderThickness="2"
                      CornerRadius="16"
                      Padding="60,40">
                <StackPanel HorizontalAlignment="Center">
                  <Ellipse Width="80" Height="80"
                           Fill="#F8F9FA"
                           Stroke="#E1E8ED"
                           StrokeThickness="2"
                           Margin="0,0,0,20">
                  </Ellipse>
                  <TextBlock Text="ðŸ“"
                             FontSize="32"
                             HorizontalAlignment="Center"
                             Margin="0,-56,0,36" />
                  <TextBlock Text="å¼€å§‹æ‚¨çš„AIæ ‡æ³¨é¡¹ç›®"
                            HorizontalAlignment="Center"
                            FontSize="20"
                            FontWeight="Medium"
                            Foreground="#2C3E50"
                            Margin="0,0,0,24" />
                  <StackPanel Orientation="Horizontal" Spacing="12">
                    <Button Content="æ–°å»ºé¡¹ç›®"
                           Command="{Binding CreateNewProjectCommand}"
                           HorizontalAlignment="Center"
                           Background="#3498DB"
                           Foreground="White"
                           BorderBrush="Transparent"
                           Padding="20,10"
                           FontSize="14"
                           FontWeight="Medium"
                           CornerRadius="10" />
                    <Button Content="æ‰“å¼€é¡¹ç›®"
                           Command="{Binding OpenProjectCommand}"
                           HorizontalAlignment="Center"
                           Background="#95A5A6"
                           Foreground="White"
                           BorderBrush="Transparent"
                           Padding="20,10"
                           FontSize="14"
                           FontWeight="Medium"
                           CornerRadius="10" />
                  </StackPanel>
                </StackPanel>
              </Border>
            </StackPanel>

            <!-- Placeholder when project exists but no image -->
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center"
                       IsVisible="{Binding HasProject}">
              <StackPanel IsVisible="{Binding !HasImage}">
                <Border Background="{DynamicResource CardBackgroundBrush}"
                        BorderBrush="{DynamicResource BorderBrush}"
                        BorderThickness="2"
                        CornerRadius="16"
                        Padding="60,40">
                  <StackPanel HorizontalAlignment="Center">
                    <Ellipse Width="80" Height="80"
                             Fill="#F8F9FA"
                             Stroke="#E1E8ED"
                             StrokeThickness="2"
                             Margin="0,0,0,20">
                    </Ellipse>
                    <TextBlock Text="ðŸ“·"
                               FontSize="32"
                               HorizontalAlignment="Center"
                               Margin="0,-56,0,36" />
                    <TextBlock Text="æ·»åŠ å›¾åƒå¼€å§‹æ ‡æ³¨"
                              HorizontalAlignment="Center"
                              FontSize="20"
                              FontWeight="Medium"
                              Foreground="#2C3E50"
                              Margin="0,0,0,24" />
                    <Button Content="æ·»åŠ å›¾åƒ"
                           Command="{Binding AddImagesCommand}"
                           HorizontalAlignment="Center"
                           Background="#27AE60"
                           Foreground="White"
                           BorderBrush="Transparent"
                           Padding="24,12"
                           FontSize="14"
                           FontWeight="Medium"
                           CornerRadius="10" />
                  </StackPanel>
                </Border>
              </StackPanel>
            </StackPanel>
          </Grid>
        </Border>

        <GridSplitter Grid.Column="3" Width="5" IsVisible="{Binding HasProject}" />

        <!-- Right Panel - Tools and Properties -->
        <Border Grid.Column="4" Background="{DynamicResource PanelBackgroundBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="1,0,0,0"
                IsVisible="{Binding HasProject}">
          <ScrollViewer VerticalScrollBarVisibility="Auto"
                        HorizontalScrollBarVisibility="Disabled">
            <StackPanel Margin="16" Spacing="0">

              <!-- å·¥å…·é€‰æ‹© -->
              <Border Classes="menu-item-container">
                <Button Content="ðŸ› ï¸ å·¥å…·é€‰æ‹©"
                        x:Name="ToolsButton"
                        Classes="sidebar-menu-item"
                        Click="OnToolsClick" />
              </Border>
              <Border x:Name="ToolsPanel"
                      IsVisible="False"
                      Classes="card animated-panel"
                      Margin="0,8,0,16"
                      Padding="16">
                <UniformGrid Columns="2">
                  <Button Content="é€‰æ‹©" Command="{Binding SelectToolCommand}" Classes="tool-button" Margin="2" />
                  <Button Content="çŸ©å½¢" Command="{Binding RectangleToolCommand}" Classes="tool-button" Margin="2" />
                  <Button Content="åœ†å½¢" Command="{Binding CircleToolCommand}" Classes="tool-button" Margin="2" />
                  <Button Content="å¤šè¾¹å½¢" Command="{Binding PolygonToolCommand}" Classes="tool-button" Margin="2" />
                  <Button Content="çº¿æ¡" Command="{Binding LineToolCommand}" Classes="tool-button" Margin="2" />
                  <Button Content="ç‚¹" Command="{Binding PointToolCommand}" Classes="tool-button" Margin="2" />
                  <Button Content="ðŸ“¦ OBB" Command="{Binding OrientedBoundingBoxToolCommand}" Classes="tool-button" Margin="2" ToolTip.Tip="æœ‰å‘è¾¹ç•Œæ¡†" />
                  <Button Content="ðŸ¤¸ å§¿æ€" Command="{Binding KeypointToolCommand}" Classes="tool-button" Margin="2" ToolTip.Tip="å…³é”®ç‚¹å§¿æ€æ ‡æ³¨" />
                </UniformGrid>
              </Border>



              <!-- æ ‡ç­¾é€‰æ‹© -->
              <Border Classes="menu-item-container">
                <Button Content="ðŸ·ï¸ æ ‡ç­¾é€‰æ‹©"
                        x:Name="LabelsButton"
                        Classes="sidebar-menu-item"
                        Click="OnLabelsClick" />
              </Border>
              <Border x:Name="LabelsPanel"
                      IsVisible="True"
                      Classes="card animated-panel"
                      Margin="0,8,0,16"
                      Padding="16">
                <StackPanel Spacing="12">
                  <Grid>
                    <Grid.ColumnDefinitions>
                      <ColumnDefinition Width="*" />
                      <ColumnDefinition Width="Auto" />
                      <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <ComboBox Grid.Column="0"
                              ItemsSource="{Binding AvailableLabels}"
                              SelectedItem="{Binding CurrentLabel}"
                              FontSize="13"
                              Padding="12,8"
                              CornerRadius="8" />
                    <Button Grid.Column="1"
                            Content="+"
                            Command="{Binding AddNewLabelCommand}"
                            Width="28"
                            Height="28"
                            Classes="success"
                            CornerRadius="14"
                            FontSize="16"
                            FontWeight="Bold"
                            Margin="8,0,4,0"
                            ToolTip.Tip="æ·»åŠ æ–°æ ‡ç­¾" />
                    <Button Grid.Column="2"
                            Content="Ã—"
                            Command="{Binding DeleteCurrentLabelCommand}"
                            Width="28"
                            Height="28"
                            Classes="danger"
                            CornerRadius="14"
                            FontSize="16"
                            FontWeight="Bold"
                            Margin="0,0,0,0"
                            ToolTip.Tip="åˆ é™¤å½“å‰æ ‡ç­¾" />
                  </Grid>
                  <Grid ColumnDefinitions="*,*">
                    <Button Grid.Column="0"
                            Content="â—€ ä¸Šä¸€ä¸ª"
                            Command="{Binding PreviousLabelCommand}"
                            Classes="accent"
                            Padding="8,10"
                            CornerRadius="8"
                            FontSize="11"
                            Margin="0,0,4,0" />
                    <Button Grid.Column="1"
                            Content="ä¸‹ä¸€ä¸ª â–¶"
                            Command="{Binding NextLabelCommand}"
                            Classes="accent"
                            Padding="8,10"
                            CornerRadius="8"
                            FontSize="11"
                            Margin="4,0,0,0" />
                  </Grid>
                  <Border Classes="success-panel">
                    <TextBlock Text="{Binding CurrentLabel, StringFormat='âœ“ å½“å‰: {0}'}"
                               Classes="primary"
                               FontSize="12"
                               HorizontalAlignment="Center"
                               FontWeight="Medium" />
                  </Border>
                  
                  <!-- æ’¤é”€/é‡åšæŒ‰é’® -->
                  <Grid ColumnDefinitions="*,*" Margin="0,8,0,0">
                    <Button Grid.Column="0"
                            Content="â†º æ’¤é”€"
                            Command="{Binding UndoCommand}"
                            Classes="secondary"
                            Padding="8,6"
                            CornerRadius="6"
                            FontSize="10"
                            Margin="0,0,4,0"
                            ToolTip.Tip="{Binding LastUndoDescription, StringFormat='Ctrl+Z: {0}'}"
                            IsEnabled="{Binding CanUndo}" />
                    <Button Grid.Column="1"
                            Content="é‡åš â†»"
                            Command="{Binding RedoCommand}"
                            Classes="secondary"
                            Padding="8,6"
                            CornerRadius="6"
                            FontSize="10"
                            Margin="4,0,0,0"
                            ToolTip.Tip="{Binding LastRedoDescription, StringFormat='Ctrl+Y: {0}'}"
                            IsEnabled="{Binding CanRedo}" />
                  </Grid>
                </StackPanel>
              </Border>

              <!-- AIè‡ªåŠ¨åŒ– -->
              <Border Classes="menu-item-container">
                <Button Content="ðŸ¤– AIè‡ªåŠ¨åŒ–"
                        x:Name="AIButton"
                        Classes="sidebar-menu-item"
                        Click="OnAIClick" />
              </Border>
              <Border x:Name="AIPanel"
                      IsVisible="False"
                      Classes="card animated-panel"
                      Margin="0,8,0,16"
                      Padding="16">
                <StackPanel Spacing="12">
                  <!-- AIçŠ¶æ€æ˜¾ç¤º -->
                  <Border Background="{DynamicResource HoverBackgroundBrush}"
                          CornerRadius="8"
                          Padding="12">
                    <StackPanel Spacing="8">
                      <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="ðŸ¤– AIæ¨¡åž‹çŠ¶æ€"
                                   FontWeight="Medium"
                                   FontSize="12" />
                        <Border Background="#FFF3E0"
                                CornerRadius="12"
                                Padding="6,3">
                          <TextBlock Text="Beta"
                                     FontSize="10"
                                     Foreground="#FF9800"
                                     FontWeight="Bold" />
                        </Border>
                      </StackPanel>

                      <TextBlock Text="ä½¿ç”¨AIæ¨¡åž‹è‡ªåŠ¨ç”Ÿæˆæ ‡æ³¨"
                                 FontSize="11"
                                 Classes="secondary"
                                 TextWrapping="Wrap" />

                      <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="æ¨¡åž‹çŠ¶æ€:" FontSize="11" Classes="secondary" />
                        <TextBlock Text="{Binding AIModelStatus}"
                                   FontSize="11"
                                   FontWeight="Medium"
                                   Classes="accent" />
                      </StackPanel>
                      <StackPanel Orientation="Horizontal" Spacing="8" IsVisible="{Binding HasAIModel}">
                        <TextBlock Text="å½“å‰æ¨¡åž‹:" FontSize="11" Classes="secondary" />
                        <TextBlock Text="{Binding CurrentAIModelName}"
                                   FontSize="11"
                                   FontWeight="Medium"
                                   Classes="primary" />
                      </StackPanel>

                      <!-- æ¨¡åž‹é…ç½®æŒ‰é’® -->
                      <Button Content="ðŸ”§ æ¨¡åž‹é…ç½®"
                              Command="{Binding ConfigureAIModelCommand}"
                              Classes="secondary"
                              Padding="12,8"
                              CornerRadius="6"
                              FontSize="11"
                              FontWeight="Medium"
                              HorizontalAlignment="Stretch"
                              Margin="0,4,0,0" />
                    </StackPanel>
                  </Border>

                  <!-- æ ‡æ³¨æŽ§åˆ¶åŒºåŸŸ -->
                  <Border Background="{DynamicResource CardBackgroundBrush}"
                          CornerRadius="8"
                          Padding="12"
                          BorderBrush="{DynamicResource BorderBrush}"
                          BorderThickness="1">
                    <StackPanel Spacing="8">
                      <TextBlock Text="ðŸ¤– AIæ ‡æ³¨æŽ§åˆ¶"
                                 FontWeight="Medium"
                                 FontSize="12"
                                 HorizontalAlignment="Center" />

                      <!-- æ ‡æ³¨æ¨¡å¼é€‰æ‹© -->
                      <StackPanel Spacing="6">
                        <TextBlock Text="æ ‡æ³¨æ¨¡å¼:"
                                   FontSize="11"
                                   Classes="secondary" />
                        <StackPanel Orientation="Horizontal" Spacing="12">
                          <RadioButton x:Name="FastModeRadio"
                                       Content="âš¡ æžé€Ÿ"
                                       IsChecked="True"
                                       FontSize="11"
                                       ToolTip.Tip="å¿«é€Ÿæ‰¹é‡æ ‡æ³¨ï¼Œç›´æŽ¥åº”ç”¨ç»“æžœ" />
                          <RadioButton x:Name="PreviewModeRadio"
                                       Content="ðŸ‘ï¸ é¢„è§ˆ"
                                       FontSize="11"
                                       ToolTip.Tip="æ˜¾ç¤ºæ ‡æ³¨é¢„è§ˆï¼Œç¡®è®¤åŽåº”ç”¨" />
                        </StackPanel>
                      </StackPanel>

                      <!-- ä¸»è¦æ ‡æ³¨æŒ‰é’® -->
                      <Button x:Name="StartAnnotationButton"
                              Content="â–¶ï¸ å¼€å§‹æ ‡æ³¨"
                              Command="{Binding StartAIAnnotationCommand}"
                              Classes="success"
                              Padding="16,12"
                              CornerRadius="8"
                              FontSize="12"
                              FontWeight="Medium"
                              HorizontalAlignment="Stretch" />

                      <!-- æŽ§åˆ¶æŒ‰é’®ç»„ -->
                      <Grid ColumnDefinitions="*,*" Margin="0,4">
                        <Button x:Name="PauseResumeButton"
                                Grid.Column="0"
                                Content="â¸ï¸ æš‚åœ"
                                Command="{Binding PauseResumeAnnotationCommand}"
                                Classes="warning"
                                Padding="10,8"
                                CornerRadius="6"
                                FontSize="10"
                                FontWeight="Medium"
                                IsEnabled="False"
                                Margin="0,0,2,0" />

                        <Button x:Name="StopAnnotationButton"
                                Grid.Column="1"
                                Content="â¹ï¸ åœæ­¢"
                                Command="{Binding StopAnnotationCommand}"
                                Classes="danger"
                                Padding="10,8"
                                CornerRadius="6"
                                FontSize="10"
                                FontWeight="Medium"
                                IsEnabled="False"
                                Margin="2,0,0,0" />
                      </Grid>

                      <!-- è¿›åº¦æ˜¾ç¤º -->
                      <StackPanel x:Name="ProgressPanel"
                                  Spacing="6"
                                  IsVisible="{Binding IsAnnotationInProgress}"
                                  Margin="0,4">
                        <!-- ä¸»è¿›åº¦æ¡ -->
                        <ProgressBar x:Name="AnnotationProgress"
                                     Height="8"
                                     CornerRadius="4"
                                     Value="{Binding AnnotationProgress}"
                                     Maximum="100"
                                     Background="{DynamicResource HoverBackgroundBrush}"
                                     Foreground="#4CAF50" />

                        <!-- è¿›åº¦æ–‡æœ¬ -->
                        <TextBlock x:Name="ProgressText"
                                   Text="{Binding AnnotationProgressText}"
                                   FontSize="10"
                                   Classes="secondary"
                                   HorizontalAlignment="Center"
                                   TextWrapping="Wrap" />

                        <!-- è¯¦ç»†çŠ¶æ€ä¿¡æ¯ -->
                        <Border Background="{DynamicResource HoverBackgroundBrush}"
                                CornerRadius="4"
                                Padding="8,4"
                                IsVisible="{Binding HasDetailedProgress}">
                          <StackPanel Spacing="2">
                            <Grid ColumnDefinitions="Auto,*,Auto">
                              <TextBlock Grid.Column="0"
                                         Text="å·²å®Œæˆ:"
                                         FontSize="9"
                                         Classes="secondary" />
                              <TextBlock Grid.Column="2"
                                         Text="{Binding ProcessedCount}"
                                         FontSize="9"
                                         FontWeight="Medium" />
                            </Grid>
                            <Grid ColumnDefinitions="Auto,*,Auto">
                              <TextBlock Grid.Column="0"
                                         Text="æ€»æ•°:"
                                         FontSize="9"
                                         Classes="secondary" />
                              <TextBlock Grid.Column="2"
                                         Text="{Binding TotalCount}"
                                         FontSize="9"
                                         FontWeight="Medium" />
                            </Grid>
                          </StackPanel>
                        </Border>
                      </StackPanel>
                    </StackPanel>
                  </Border>

                  <!-- ä¼ ç»ŸæŒ‰é’®ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰ -->
                  <StackPanel Spacing="8">
                    <Separator Margin="0,8" />
                    <TextBlock Text="ä¼ ç»Ÿæ¨¡å¼"
                               FontSize="11"
                               Classes="secondary"
                               HorizontalAlignment="Center" />

                    <Button Content="ðŸ¤– è‡ªåŠ¨æŽ¨ç†æœªæ ‡æ³¨å›¾ç‰‡"
                            Command="{Binding RunAutoInferenceCommand}"
                            Classes="secondary"
                            Padding="16,10"
                            CornerRadius="8"
                            FontSize="12"
                            FontWeight="Medium" />
                    <Button Content="âš¡ æ‰‹åŠ¨æŽ¨ç†å½“å‰å›¾ç‰‡"
                            Command="{Binding RunAIInferenceCommand}"
                            Classes="accent"
                            Padding="16,10"
                            CornerRadius="8"
                            FontSize="12"
                            FontWeight="Medium" />
                    <Button Content="ðŸ“¦ æ‰¹é‡æŽ¨ç†æ‰€æœ‰å›¾ç‰‡"
                            Command="{Binding RunBatchAIInferenceCommand}"
                            Classes="danger"
                            Padding="16,10"
                            CornerRadius="8"
                            FontSize="12"
                            FontWeight="Medium" />
                  </StackPanel>
                </StackPanel>
              </Border>

              <!-- æ‘„åƒå¤´æ‹ç…§ -->
              <Border Classes="menu-item-container">
                <Button Content="ðŸ“· æ‘„åƒå¤´æ‹ç…§"
                        x:Name="CameraButton"
                        Classes="sidebar-menu-item"
                        Click="OnCameraClick" />
              </Border>
              <Border x:Name="CameraPanel"
                      IsVisible="False"
                      Classes="card animated-panel"
                      Margin="0,8,0,16"
                      Padding="16">
                <StackPanel Spacing="12">
                  <!-- æ‘„åƒå¤´çŠ¶æ€æ˜¾ç¤º -->
                  <Border Background="{DynamicResource HoverBackgroundBrush}"
                          CornerRadius="8"
                          Padding="12">
                    <StackPanel Spacing="8">
                      <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="ðŸ“· æ‘„åƒå¤´çŠ¶æ€"
                                   FontWeight="Medium"
                                   FontSize="12" />
                        <Border Background="#FFF3E0"
                                CornerRadius="12"
                                Padding="6,3">
                          <TextBlock Text="Beta"
                                     FontSize="10"
                                     Foreground="#FF9800"
                                     FontWeight="Bold" />
                        </Border>
                      </StackPanel>

                      <TextBlock Text="ä½¿ç”¨æ‘„åƒå¤´å®žæ—¶æ‹ç…§æ·»åŠ å›¾åƒåˆ°é¡¹ç›®"
                                 FontSize="11"
                                 Classes="secondary"
                                 TextWrapping="Wrap" />

                      <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="æ‘„åƒå¤´:" FontSize="11" Classes="secondary" />
                        <TextBlock Text="{Binding CameraStatus}"
                                   FontSize="11"
                                   FontWeight="Medium"
                                   Classes="accent" />
                      </StackPanel>
                      
                      <StackPanel Orientation="Horizontal" Spacing="8" IsVisible="{Binding IsCameraActive}">
                        <TextBlock Text="å·²æ•èŽ·:" FontSize="11" Classes="secondary" />
                        <TextBlock Text="{Binding CaptureCount}"
                                   FontSize="11"
                                   FontWeight="Medium"
                                   Classes="primary" />
                        <TextBlock Text="å¼ " FontSize="11" Classes="secondary" />
                      </StackPanel>
                    </StackPanel>
                  </Border>

                  <!-- æ‘„åƒå¤´é¢„è§ˆåŒºåŸŸ -->
                  <Border Background="{DynamicResource CardBackgroundBrush}"
                          CornerRadius="8"
                          Padding="12"
                          BorderBrush="{DynamicResource BorderBrush}"
                          BorderThickness="1"
                          Height="200">
                    <controls:CameraPreviewControl x:Name="CameraPreview"
                                                   CameraService="{Binding CameraService}"
                                                   CaptureRequested="OnCameraCaptureRequested"
                                                   ErrorOccurred="OnCameraErrorOccurred" />
                  </Border>

                  <!-- æ‘„åƒå¤´æŽ§åˆ¶æŒ‰é’® -->
                  <Border Background="{DynamicResource CardBackgroundBrush}"
                          CornerRadius="8"
                          Padding="12"
                          BorderBrush="{DynamicResource BorderBrush}"
                          BorderThickness="1">
                    <StackPanel Spacing="8">
                      <TextBlock Text="ðŸŽ® æ‘„åƒå¤´æŽ§åˆ¶"
                                 FontWeight="Medium"
                                 FontSize="12"
                                 HorizontalAlignment="Center" />

                      <!-- ä¸»è¦æŽ§åˆ¶æŒ‰é’® -->
                      <Button x:Name="StartCameraButton"
                              Content="â–¶ï¸ å¯åŠ¨æ‘„åƒå¤´"
                              Command="{Binding StartCameraCommand}"
                              Classes="success"
                              Padding="16,12"
                              CornerRadius="8"
                              FontSize="12"
                              FontWeight="Medium"
                              HorizontalAlignment="Stretch"
                              IsVisible="{Binding !IsCameraActive}" />

                      <!-- åœæ­¢æŒ‰é’® -->
                      <Button x:Name="StopCameraButton"
                              Content="â¹ï¸ åœæ­¢æ‘„åƒå¤´"
                              Command="{Binding StopCameraCommand}"
                              Classes="danger"
                              Padding="16,12"
                              CornerRadius="8"
                              FontSize="12"
                              FontWeight="Medium"
                              HorizontalAlignment="Stretch"
                              IsVisible="{Binding IsCameraActive}" />

                      <!-- æ•èŽ·æŒ‰é’® -->
                      <Button x:Name="CaptureCameraButton"
                              Content="ðŸ“¸ æ•èŽ·å›¾åƒ (ç©ºæ ¼)"
                              Command="{Binding CaptureCameraImageCommand}"
                              Classes="accent"
                              Padding="16,12"
                              CornerRadius="8"
                              FontSize="12"
                              FontWeight="Medium"
                              HorizontalAlignment="Stretch"
                              IsVisible="{Binding IsCameraActive}" />

                      <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
                      <StackPanel x:Name="CameraLoadingPanel"
                                  Orientation="Horizontal"
                                  Spacing="8"
                                  HorizontalAlignment="Center"
                                  IsVisible="{Binding IsCameraLoading}"
                                  Margin="0,4">
                        <Border Width="16" Height="16"
                                Background="#2196F3"
                                CornerRadius="8">
                          <Border.Styles>
                            <Style Selector="Border">
                              <Style.Animations>
                                <Animation Duration="0:0:1" IterationCount="INFINITE">
                                  <KeyFrame Cue="0%">
                                    <Setter Property="Opacity" Value="0.5" />
                                  </KeyFrame>
                                  <KeyFrame Cue="50%">
                                    <Setter Property="Opacity" Value="1" />
                                  </KeyFrame>
                                  <KeyFrame Cue="100%">
                                    <Setter Property="Opacity" Value="0.5" />
                                  </KeyFrame>
                                </Animation>
                              </Style.Animations>
                            </Style>
                          </Border.Styles>
                        </Border>
                        <TextBlock Text="æ­£åœ¨åŠ è½½..."
                                   FontSize="11"
                                   Classes="secondary"
                                   VerticalAlignment="Center" />
                      </StackPanel>

                      <!-- æç¤ºä¿¡æ¯ -->
                      <Border Background="{DynamicResource HoverBackgroundBrush}"
                              CornerRadius="4"
                              Padding="8,4"
                              IsVisible="{Binding IsCameraActive}">
                        <TextBlock Text="âœ¨ æç¤º: æŒ‰ç©ºæ ¼é”®å¿«é€Ÿæ•èŽ·å›¾åƒ"
                                   FontSize="10"
                                   Classes="secondary"
                                   HorizontalAlignment="Center"
                                   TextWrapping="Wrap" />
                      </Border>
                    </StackPanel>
                  </Border>
                </StackPanel>
              </Border>
            </StackPanel>
          </ScrollViewer>
        </Border>
      </Grid>
      
      <!-- AIèŠå¤©è§†å›¾ -->
      <Grid IsVisible="{Binding IsAIChatViewActive}">
        <DockPanel>
          <!-- AIèŠå¤©é¡¶éƒ¨æ  -->
          <Border DockPanel.Dock="Top" Background="{DynamicResource PanelBackgroundBrush}" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1" Padding="16,12">
            <Grid>
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
              </Grid.ColumnDefinitions>
              
              <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12">
                <TextBlock Text="ðŸ¤– AIåŠ©æ‰‹èŠå¤©" FontSize="18" FontWeight="SemiBold" VerticalAlignment="Center" />
                <Border Background="#4CAF50" CornerRadius="12" Padding="8,4">
                  <TextBlock Text="åµŒå…¥æ¨¡å¼" FontSize="12" Foreground="White" />
                </Border>
                
                <!-- AIçŠ¶æ€å’ŒæŽ§åˆ¶æŒ‰é’® -->
                <StackPanel Orientation="Horizontal" Spacing="8" Margin="16,0,0,0">
                  <!-- AIè¿žæŽ¥çŠ¶æ€ -->
                  <Border Background="#4CAF50" CornerRadius="12" Padding="8,4" IsVisible="{Binding AiChatViewModel.IsConfigured}">
                    <TextBlock Text="âœ“ AIå·²è¿žæŽ¥" FontSize="12" Foreground="White" />
                  </Border>
                  <Border Background="#FF9800" CornerRadius="12" Padding="8,4" IsVisible="{Binding !AiChatViewModel.IsConfigured}">
                    <TextBlock Text="âš  AIæœªé…ç½®" FontSize="12" Foreground="White" />
                  </Border>
                  
                  <!-- æŽ§åˆ¶æŒ‰é’® -->
                  <Button Content="âš™ï¸ è®¾ç½®" 
                          Command="{Binding AiChatViewModel.ToggleConfigPanelCommand}" 
                          Classes="secondary" 
                          Padding="8,6" 
                          ToolTip.Tip="AIé…ç½®" />
                  <Button Content="ðŸ’¾ ä¿å­˜" 
                          Command="{Binding AiChatViewModel.SaveChatCommand}" 
                          Classes="secondary" 
                          Padding="8,6" 
                          ToolTip.Tip="ä¿å­˜èŠå¤©è®°å½•" />
                  <Button Content="ðŸ—‘ï¸ æ¸…ç©º" 
                          Command="{Binding AiChatViewModel.ClearChatCommand}" 
                          Classes="secondary" 
                          Padding="8,6" 
                          ToolTip.Tip="æ¸…ç©ºèŠå¤©" />
                </StackPanel>
              </StackPanel>
              
              <Button Grid.Column="1" 
                      Content="è¿”å›žæ ‡æ³¨" 
                      Command="{Binding BackToAnnotationCommand}"
                      Background="#2196F3" 
                      Foreground="White" 
                      BorderBrush="Transparent" 
                      Padding="16,8" 
                      CornerRadius="6" 
                      FontWeight="Medium" />
            </Grid>
          </Border>
          
          <!-- AIèŠå¤©å†…å®¹ -->
          <ContentControl Content="{Binding AiChatViewModel}" DockPanel.Dock="Top">
            <ContentControl.ContentTemplate>
              <DataTemplate>
                <views:AIChatView />
              </DataTemplate>
            </ContentControl.ContentTemplate>
          </ContentControl>
        </DockPanel>
      </Grid>
    </Grid>
  </DockPanel>
</UserControl>
