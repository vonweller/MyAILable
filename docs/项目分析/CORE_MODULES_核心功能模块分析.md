# AIlable核心功能模块分析

## 概述
AIlable项目包含多个核心功能模块，每个模块都有明确的职责和良好的架构设计。本文档详细分析了各个核心功能模块的实现原理、技术特点和扩展方式。

## 1. 图像标注功能模块

### 1.1 标注工具架构
- **核心控件**: `ImageCanvas.cs` - 自定义画布控件，负责图像显示和标注交互
- **工具服务**: `AnnotationTools.cs` - 标注工具管理服务
- **专用工具**: 
  - `OrientedBoundingBoxTool.cs` - 有向边界框工具
  - `KeypointTool.cs` - 关键点标注工具

### 1.2 支持的标注类型
1. **矩形标注** (`RectangleAnnotation`)
   - 基础的边界框标注
   - 支持拖拽调整大小和位置
   
2. **圆形标注** (`CircleAnnotation`)
   - 圆形区域标注
   - 支持半径调整
   
3. **多边形标注** (`PolygonAnnotation`)
   - 任意形状的多边形标注
   - 支持顶点编辑和添加/删除
   
4. **线条标注** (`LineAnnotation`)
   - 直线标注
   - 支持起点和终点调整
   
5. **点标注** (`PointAnnotation`)
   - 单点标记
   - 支持点大小调整
   
6. **关键点标注** (`KeypointAnnotation`)
   - 人体姿态关键点标注
   - 支持17个COCO标准关键点
   - 包含可见性状态管理
   
7. **有向边界框标注** (`OrientedBoundingBoxAnnotation`)
   - 支持旋转的矩形标注
   - 适用于倾斜目标检测

### 1.3 标注数据模型
- **基类**: `Annotation` - 所有标注类型的基类
- **通用属性**: ID、标签、颜色、线宽、可见性
- **几何计算**: 面积计算、边界框获取、坐标转换
- **序列化支持**: JSON序列化/反序列化

### 1.4 交互机制
- **鼠标事件处理**: 点击、拖拽、双击等交互
- **键盘快捷键**: 工具切换、操作确认/取消
- **撤销重做**: `UndoRedoService` 支持操作历史管理
- **智能工具切换**: `SmartToolSwitchingService` 自动工具选择

## 2. AI模型集成模块

### 2.1 AI模型管理架构
- **管理器**: `AIModelManager` - 统一的AI模型管理
- **服务接口**: `IAIModelService` - AI模型服务抽象接口
- **具体实现**:
  - `YoloModelService` - YOLO目标检测模型
  - `OBBModelService` - 有向边界框检测模型
  - `SegmentationModelService` - 图像分割模型

### 2.2 YOLO模型服务详细分析
**核心功能**:
- 支持多种YOLO格式（YOLOv8原始格式、NMS处理后格式）
- 自动类别名称管理（项目标签优先、COCO默认标签）
- 图像预处理（640x640标准化、填充保持比例）
- 后处理（NMS非极大值抑制、坐标转换）

**技术特点**:
- 使用ONNX Runtime进行推理
- 支持批量推理
- 智能输出格式检测
- 完整的坐标转换链（模型坐标→原图坐标）

**扩展点**:
- 支持自定义类别标签
- 可配置置信度阈值
- 支持不同输入尺寸的模型

### 2.3 模型推理流程
1. **模型加载**: 验证文件存在性、创建ONNX会话、加载类别名称
2. **图像预处理**: 尺寸调整、归一化、张量转换
3. **推理执行**: ONNX Runtime推理
4. **结果后处理**: 格式解析、NMS处理、坐标转换
5. **标注生成**: 创建对应的标注对象

### 2.4 AI模型配置
- **模型类型**: YOLO、SegmentAnything、Custom(OBB)
- **项目标签集成**: 自动使用项目定义的标签
- **动态模型切换**: 运行时加载/卸载不同模型
- **批量推理**: 支持多图像并行处理

## 3. 语音交互模块

### 3.1 语音录制服务
**核心类**: `VoiceRecordingService`

**功能特性**:
- 跨平台录音支持（Windows、Linux、macOS）
- 录音状态管理（Idle、Recording、Processing）
- 实时录音进度监控
- 自动录音时长限制（60秒）
- 临时文件管理和清理

**技术实现**:
- Windows: 模拟录音实现（实际项目建议使用NAudio）
- Linux: 使用arecord命令行工具
- macOS: 系统录音API调用
- WAV格式输出（44.1kHz, 16位, 单声道）

### 3.2 音频处理
- **格式支持**: WAV格式为主
- **数据处理**: 字节数组和Base64编码转换
- **质量控制**: 音频数据完整性检查
- **异常处理**: 录音失败的优雅降级

### 3.3 语音与AI集成
- 录音数据可直接传递给AI聊天服务
- 支持语音转文本（通过AI模型）
- 音频数据的临时存储和管理

## 4. AI聊天助手模块

### 4.1 聊天服务架构
**核心类**: `AIChatService`

**支持的AI提供商**:
- OpenAI (GPT系列)
- DeepSeek
- 阿里云通义千问
- Ollama (本地部署)

### 4.2 多模态消息支持
**消息类型**:
1. **文本消息**: 纯文本对话
2. **图像消息**: 图片+文本，支持Vision API
3. **音频消息**: 语音输入，支持全模态模型
4. **视频消息**: 视频帧序列分析
5. **文件消息**: 文档内容分析

**技术实现**:
- Base64编码处理多媒体数据
- MIME类型自动识别
- 文件内容智能解析（文本/二进制）
- 视频帧提取和处理

### 4.3 流式响应处理
- **实时流式输出**: 支持Server-Sent Events
- **音频输出处理**: 全模态模型的语音合成
- **错误恢复**: 网络中断和API错误处理
- **数据完整性**: 音频数据的收集和验证

### 4.4 配置管理
- **多提供商配置**: 统一的配置接口
- **API密钥管理**: 安全的认证处理
- **参数调优**: 温度、最大令牌数等参数
- **模型选择**: 支持不同能力的模型切换

## 5. 项目管理模块

### 5.1 项目服务
**核心类**: `ProjectService`

**功能特性**:
- 项目文件的保存和加载（.ailproj格式）
- 图像路径验证和修复
- 图像尺寸自动获取
- 项目元数据管理

### 5.2 数据导出服务
**核心类**: `ExportService`

**支持的导出格式**:
1. **COCO格式**: 
   - 完整的COCO数据集结构
   - 支持所有标注类型转换
   - 自动生成类别映射
   
2. **YOLO格式**:
   - 标准YOLO训练格式
   - 支持检测和分割格式
   - 自动train/val数据集分割
   - 生成配置文件（data.yaml）
   
3. **VOC格式**:
   - Pascal VOC XML格式
   - 边界框标注支持
   - 完整的元数据信息
   
4. **JSON格式**:
   - 原生项目格式导出
   - 保留所有标注信息

### 5.3 标注数据处理
- **标签清理**: 自动去除置信度分数
- **坐标转换**: 不同格式间的坐标系转换
- **数据验证**: 标注数据的完整性检查
- **批量处理**: 支持大量图像的批量导出

## 6. 辅助功能模块

### 6.1 性能监控
- **服务**: `PerformanceMonitorService`
- **功能**: 系统资源监控、操作耗时统计
- **用途**: 性能优化和问题诊断

### 6.2 通知系统
- **服务**: `NotificationService`
- **功能**: 用户操作反馈、状态通知
- **UI**: Toast通知组件

### 6.3 用户体验服务
- **服务**: `UserExperienceService`
- **功能**: 用户行为分析、体验优化
- **数据**: 操作统计和偏好记录

### 6.4 主题系统
- **服务**: `ThemeService`
- **功能**: 明暗主题切换
- **实现**: 动态样式资源管理

## 7. 模块间协作机制

### 7.1 服务注册和依赖注入
- 所有服务通过DI容器管理
- 接口抽象确保松耦合
- 生命周期管理（单例/瞬态）

### 7.2 事件驱动架构
- 标注变更事件
- AI推理完成事件
- 项目状态变更事件

### 7.3 数据流转
```
用户操作 → ViewModel → Service → Model → 数据持久化
         ↓
    UI更新 ← 数据绑定 ← 属性变更通知
```

## 8. 扩展和定制指南

### 8.1 添加新的标注类型
1. 继承`Annotation`基类
2. 实现几何计算方法
3. 添加对应的工具类
4. 更新导出服务支持

### 8.2 集成新的AI模型
1. 实现`IAIModelService`接口
2. 在`AIModelManager`中注册
3. 添加模型特定的预处理逻辑
4. 实现结果后处理

### 8.3 扩展导出格式
1. 在`ExportService`中添加新方法
2. 实现格式特定的数据转换
3. 更新`ExportFormat`枚举
4. 添加UI选项支持

### 8.4 自定义AI提供商
1. 扩展`AIProviderType`枚举
2. 在`AIChatService`中添加支持
3. 实现特定的API调用逻辑
4. 添加配置选项

## 9. 技术亮点总结

1. **模块化设计**: 清晰的职责分离和接口抽象
2. **跨平台兼容**: 统一的API适配不同平台特性
3. **AI集成深度**: 从模型推理到结果应用的完整链路
4. **多模态支持**: 文本、图像、音频、视频的统一处理
5. **数据格式兼容**: 支持主流的标注数据格式
6. **用户体验优化**: 智能工具切换、实时反馈、撤销重做
7. **扩展性设计**: 良好的扩展点和插件化架构

这些核心功能模块构成了AIlable强大而灵活的图像标注平台，为二次开发提供了坚实的基础。